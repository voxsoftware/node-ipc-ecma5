'use strict';

var net = require('net'),
    tls = require('tls'),
    fs = require('fs'),
    dgram = require('dgram'),
    eventParser = require('./eventParser.js'),
    Pubsub = require('event-pubsub'),
    Message = require('js-message');

function emit(socket, type, data) {
    this.log('dispatching event to socket'.debug, ' : ', type.data, data);

    var message = new Message();
    message.type = type;
    message.data = data;

    if (this.config.rawBuffer) {
        message = new Buffer(type, this.encoding);
    } else {
        message = eventParser.format(message);
    }

    if (this.udp4 || this.udp6) {

        if (!socket.address || !socket.port) {
            this.log('Attempting to emit to a single UDP socket without supplying socket address or port. Redispatching event as broadcast to all connected sockets');
            this.broadcast(type, data);
            return;
        }

        this.server.write(message, socket);
        return;
    }

    socket.write(message);
}

function broadcast(type, data) {
    this.log('broadcasting event to all known sockets listening to '.debug, this.path.variable, ' : ', this.port ? this.port : '', type, data);
    var message = new Message();
    message.type = type;
    message.data = data;

    if (this.config.rawBuffer) {
        message = new Buffer(type, this.encoding);
    } else {
        message = eventParser.format(message);
    }

    if (this.udp4 || this.udp6) {
        for (var i = 1, count = this.sockets.length; i < count; i++) {
            this.server.write(message, this.sockets[i]);
        }
    } else {
        for (var i = 0, count = this.sockets.length; i < count; i++) {
            this.sockets[i].write(message);
        }
    }
}

function init(path, config, log, port) {
    var server = {
        config: config,
        path: path,
        port: port,
        udp4: false,
        udp6: false,
        log: log,
        server: false,
        sockets: [],
        emit: emit,
        broadcast: broadcast,
        onStart: function onStart(socket) {
            this.trigger('start', socket);
        },
        stop: function stop() {
            server.server.close();
        },
        start: function start() {
            if (!this.path) {
                server.log('Socket Server Path not specified, refusing to start'.warn);
                return;
            }

            fs.unlink(this.path, function () {
                server.log('starting server on '.debug, server.path.variable, (server.port ? ':' + server.port : '').variable);

                if (!server.udp4 && !server.udp6) {
                    if (!server.config.tls) {
                        server.server = net.createServer(serverCreated);
                    } else {
                        server.log('starting TLS server'.debug, server.config.tls);
                        if (server.config.tls.private) {
                            server.config.tls.key = fs.readFileSync(server.config.tls.private);
                        } else {
                            server.config.tls.key = fs.readFileSync(__dirname + '/../local-node-ipc-certs/private/server.key');
                        }
                        if (server.config.tls.public) {
                            server.config.tls.cert = fs.readFileSync(server.config.tls.public);
                        } else {
                            server.config.tls.cert = fs.readFileSync(__dirname + '/../local-node-ipc-certs/server.pub');
                        }
                        if (server.config.tls.dhparam) {
                            server.config.tls.dhparam = fs.readFileSync(server.config.tls.dhparam);
                        }
                        if (server.config.tls.trustedConnections) {
                            if (typeof server.config.tls.trustedConnections === 'string') {
                                server.config.tls.trustedConnections = [server.config.tls.trustedConnections];
                            }
                            server.config.tls.ca = [];
                            for (var i = 0; i < server.config.tls.trustedConnections.length; i++) {
                                server.config.tls.ca.push(fs.readFileSync(server.config.tls.trustedConnections[i]));
                            }
                        }
                        server.server = tls.createServer(server.config.tls, serverCreated);
                    }
                } else {
                    var UDPWrite = function UDPWrite(message, socket) {
                        var data = new Buffer(message, server.config.encoding);
                        server.server.send(data, 0, data.length, socket.port, socket.address, function (err, bytes) {
                            if (err) {
                                server.log('error writing data to socket'.warn, err);
                                server.trigger('error', function (err) {
                                    server.trigger('error', err);
                                });
                            }
                        });
                    };

                    server.server = dgram.createSocket(server.udp4 ? 'udp4' : 'udp6');
                    server.server.write = UDPWrite;
                    server.server.on('listening', function () {
                        serverCreated(server.server);
                    });
                }

                server.server.on('error', function (err) {
                    server.log('server error'.warn, err);

                    server.trigger('error', err);
                });

                server.server.maxConnections = server.config.maxConnections;

                function serverCreated(socket) {
                    server.sockets.push(socket);

                    if (socket.setEncoding) {
                        socket.setEncoding(server.config.encoding);
                    }

                    server.log('## socket connection to server detected ##'.rainbow);
                    socket.on('close', function (socket) {
                        server.trigger('close', socket);
                    });

                    socket.on('error', function (err) {
                        server.log('server socket error'.warn, err);

                        server.trigger('error', err);
                    });

                    socket.on('data', function (data, UDPSocket) {
                        var sock = server.udp4 || server.udp6 ? UDPSocket : socket;
                        if (server.config.rawBuffer) {
                            data = new Buffer(data, this.encoding);
                            server.trigger('data', data, sock);
                            return;
                        }

                        if (!this.ipcBuffer) {
                            this.ipcBuffer = '';
                        }

                        data = this.ipcBuffer += data;

                        if (data.slice(-1) != eventParser.delimiter || data.indexOf(eventParser.delimiter) == -1) {
                            server.log('Implementing larger buffer for this socket message. You may want to consider smaller messages'.notice);
                            return;
                        }

                        this.ipcBuffer = '';

                        data = eventParser.parse(data);

                        while (data.length > 0) {
                            var message = new Message();
                            message.load(data.shift());

                            server.log('received event of : '.debug, message.type.data, message.data);

                            if (message.data.id) {
                                sock.id = message.data.id;
                            }

                            server.trigger(message.type, message.data, sock);
                        }
                    });

                    socket.on('message', function (msg, rinfo) {
                        if (!rinfo) {
                            return;
                        }

                        server.log('Received UDP message from '.debug, rinfo.address.variable, rinfo.port);
                        var data = undefined;

                        if (server.config.rawSocket) {
                            data = new Buffer(msg, this.encoding);
                        } else {
                            data = msg.toString();
                        }
                        socket.emit('data', data, rinfo);
                    });

                    server.trigger('connect', socket);

                    if (server.config.rawBuffer) {
                        return;
                    }
                }

                function started(socket) {
                    server.onStart(socket);
                }

                if (!port) {
                    server.log('starting server as'.debug, 'Unix || Windows Socket'.variable);
                    if (process.platform === 'win32') {
                        server.path = server.path.replace(/^\//, '');
                        server.path = server.path.replace(/\//g, '-');
                        server.path = '\\\\.\\pipe\\' + server.path;
                    }

                    server.server.listen(server.path, started);

                    return;
                }

                if (!server.udp4 && !server.udp6) {
                    server.log('starting server as'.debug, (server.config.tls ? 'TLS' : 'TCP').variable);
                    server.server.listen(server.port, server.path, started);
                    return;
                }

                server.log('starting server as'.debug, (server.udp4 ? 'udp4' : 'udp6').variable);
                server.server.bind(server.port, server.path);

                started({
                    address: server.path,
                    port: server.port
                });
            });
        }
    };

    new Pubsub(server);

    server.on('close', function () {
        for (var i = 0, count = server.sockets.length; i < count; i++) {
            var socket = server.sockets[i];
            var destroyedSocketId = false;

            if (socket) {
                if (socket.readable) {
                    continue;
                }
            }

            if (socket.id) {
                destroyedSocketId = socket.id;
            }

            server.log('socket disconnected'.notice, destroyedSocketId.toString().variable);

            if (socket && socket.destroy) {
                socket.destroy();
            }

            server.sockets.splice(i, 1);

            server.trigger('socket.disconnected', socket, destroyedSocketId);

            return;
        }
    });

    return server;
}

module.exports = init;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL25vZGUtaXBjL2Rhby9zb2NrZXRTZXJ2ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTSxNQUFNLFFBQVEsS0FBUixDQUFOO0lBQ0YsTUFBTSxRQUFRLEtBQVIsQ0FBTjtJQUNBLEtBQUssUUFBUSxJQUFSLENBQUw7SUFDQSxRQUFRLFFBQVEsT0FBUixDQUFSO0lBQ0EsY0FBYyxRQUFRLGtCQUFSLENBQWQ7SUFDQSxTQUFTLFFBQVEsY0FBUixDQUFUO0lBQ0EsVUFBVSxRQUFRLFlBQVIsQ0FBVjs7QUFFSixTQUFTLElBQVQsQ0FBYyxNQUFkLEVBQXNCLElBQXRCLEVBQTRCLElBQTVCLEVBQWlDO0FBQzdCLFNBQUssR0FBTCxDQUFTLDhCQUE4QixLQUE5QixFQUFxQyxLQUE5QyxFQUFxRCxLQUFLLElBQUwsRUFBVyxJQUFoRSxFQUQ2Qjs7QUFHN0IsUUFBSSxVQUFRLElBQUksT0FBSixFQUFSLENBSHlCO0FBSTdCLFlBQVEsSUFBUixHQUFhLElBQWIsQ0FKNkI7QUFLN0IsWUFBUSxJQUFSLEdBQWEsSUFBYixDQUw2Qjs7QUFPN0IsUUFBRyxLQUFLLE1BQUwsQ0FBWSxTQUFaLEVBQXNCO0FBQ3JCLGtCQUFRLElBQUksTUFBSixDQUFXLElBQVgsRUFBZ0IsS0FBSyxRQUFMLENBQXhCLENBRHFCO0tBQXpCLE1BRUs7QUFDRCxrQkFBUSxZQUFZLE1BQVosQ0FBbUIsT0FBbkIsQ0FBUixDQURDO0tBRkw7O0FBTUEsUUFBRyxLQUFLLElBQUwsSUFBYSxLQUFLLElBQUwsRUFBVTs7QUFFdEIsWUFBRyxDQUFDLE9BQU8sT0FBUCxJQUFrQixDQUFDLE9BQU8sSUFBUCxFQUFZO0FBQy9CLGlCQUFLLEdBQUwsQ0FBUywrSUFBVCxFQUQrQjtBQUUvQixpQkFBSyxTQUFMLENBQWUsSUFBZixFQUFvQixJQUFwQixFQUYrQjtBQUcvQixtQkFIK0I7U0FBbkM7O0FBTUEsYUFBSyxNQUFMLENBQVksS0FBWixDQUNJLE9BREosRUFFSSxN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LE1BQUosQ0FBVyxNQUFYLEVBL1ErQjs7QUFpUi9CLFdBQU8sRUFBUCxDQUNJLE9BREosRUFFSSxZQUFVO0FBQ04sYUFBSSxJQUFJLElBQUUsQ0FBRixFQUFLLFFBQU0sT0FBTyxPQUFQLENBQWUsTUFBZixFQUF1QixJQUFFLEtBQUYsRUFBUyxHQUFuRCxFQUF1RDtBQUNuRCxnQkFBSSxTQUFPLE9BQU8sT0FBUCxDQUFlLENBQWYsQ0FBUCxDQUQrQztBQUVuRCxnQkFBSSxvQkFBa0IsS0FBbEIsQ0FGK0M7O0FBSW5ELGdCQUFHLE1BQUgsRUFBVTtBQUNOLG9CQUFHLE9BQU8sUUFBUCxFQUFnQjtBQUNmLDZCQURlO2lCQUFuQjthQURKOztBQU1BLGdCQUFHLE9BQU8sRUFBUCxFQUFVO0FBQ1Qsb0NBQWtCLE9BQU8sRUFBUCxDQURUO2FBQWI7O0FBSUEsbUJBQU8sR0FBUCxDQUFXLHNCQUFzQixNQUF0QixFQUE2QixrQkFBa0IsUUFBbEIsR0FBNkIsUUFBN0IsQ0FBeEMsQ0FkbUQ7O0FBZ0JuRCxnQkFBRyxVQUFVLE9BQU8sT0FBUCxFQUFlO0FBQ3hCLHVCQUFPLE9BQVAsR0FEd0I7YUFBNUI7O0FBSUEsbUJBQU8sT0FBUCxDQUFlLE1BQWYsQ0FBc0IsQ0FBdEIsRUFBd0IsQ0FBeEIsRUFwQm1EOztBQXNCbkQsbUJBQU8sT0FBUCxDQUFlLHFCQUFmLEVBQXNDLE1BQXRDLEVBQThDLGlCQUE5QyxFQXRCbUQ7O0FBd0JuRCxtQkF4Qm1EO1NBQXZEO0tBREosQ0FGSixDQWpSK0I7O0FBaVQvQixXQUFPLE1BQVAsQ0FqVCtCO0NBQW5DOztBQW9UQSxPQUFPLE9BQVAsR0FBZSxJQUFmIiwiZmlsZSI6InNvY2tldFNlcnZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbmV0ID0gcmVxdWlyZSgnbmV0JyksXG4gICAgdGxzID0gcmVxdWlyZSgndGxzJyksXG4gICAgZnMgPSByZXF1aXJlKCdmcycpLFxuICAgIGRncmFtID0gcmVxdWlyZSgnZGdyYW0nKSxcbiAgICBldmVudFBhcnNlciA9IHJlcXVpcmUoJy4vZXZlbnRQYXJzZXIuanMnKSxcbiAgICBQdWJzdWIgPSByZXF1aXJlKCdldmVudC1wdWJzdWInKSxcbiAgICBNZXNzYWdlID0gcmVxdWlyZSgnanMtbWVzc2FnZScpO1xuXG5mdW5jdGlvbiBlbWl0KHNvY2tldCwgdHlwZSwgZGF0YSl7XG4gICAgdGhpcy5sb2coJ2Rpc3BhdGNoaW5nIGV2ZW50IHRvIHNvY2tldCcuZGVidWcsICcgOiAnLCB0eXBlLmRhdGEsIGRhdGEpO1xuXG4gICAgbGV0IG1lc3NhZ2U9bmV3IE1lc3NhZ2U7XG4gICAgbWVzc2FnZS50eXBlPXR5cGU7XG4gICAgbWVzc2FnZS5kYXRhPWRhdGE7XG5cbiAgICBpZih0aGlzLmNvbmZpZy5yYXdCdWZmZXIpe1xuICAgICAgICBtZXNzYWdlPW5ldyBCdWZmZXIodHlwZSx0aGlzLmVuY29kaW5nKTtcbiAgICB9ZWxzZXtcbiAgICAgICAgbWVzc2FnZT1ldmVudFBhcnNlci5mb3JtYXQobWVzc2FnZSk7XG4gICAgfVxuXG4gICAgaWYodGhpcy51ZHA0IHx8IHRoaXMudWRwNil7XG5cbiAgICAgICAgaWYoIXNvY2tldC5hZGRyZXNzIHx8ICFzb2NrZXQucG9ydCl7XG4gICAgICAgICAgICB0aGlzLmxvZygnQXR0ZW1wdGluZyB0byBlbWl0IHRvIGEgc2luZ2xlIFVEUCBzb2NrZXQgd2l0aG91dCBzdXBwbHlpbmcgc29ja2V0IGFkZHJlc3Mgb3IgcG9ydC4gUmVkaXNwYXRjaGluZyBldmVudCBhcyBicm9hZGNhc3QgdG8gYWxsIGNvbm5lY3RlZCBzb2NrZXRzJyk7XG4gICAgICAgICAgICB0aGlzLmJyb2FkY2FzdCh0eXBlLGRhdGEpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXJ2ZXIud3JpdGUoXG4gICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgc29ja2V0XG4gICAgICAgICk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBzb2NrZXQud3JpdGUobWVzc2FnZSk7XG59XG5cbmZ1bmN0aW9uIGJyb2FkY2FzdCh0eXBlLGRhdGEpe1xuICAgIHRoaXMubG9nKCdicm9hZGNhc3RpbmcgZXZlbnQgdG8gYWxsIGtub3duIHNvY2tldHMgbGlzdGVuaW5nIHRvICcuZGVidWcsIHRoaXMucGF0aC52YXJpYWJsZSwnIDogJywgKCh0aGlzLnBvcnQpP3RoaXMucG9ydDonJyksIHR5cGUsIGRhdGEpO1xuICAgIGxldCBtZXNzYWdlPW5ldyBNZXNzYWdlO1xuICAgIG1lc3NhZ2UudHlwZT10eXBlO1xuICAgIG1lc3NhZ2UuZGF0YT1kYXRhO1xuXG4gICAgaWYodGhpcy5jb25maWcucmF3QnVmZmVyKXtcbiAgICAgICAgbWVzc2FnZT1uZXcgQnVmZmVyKHR5cGUsdGhpcy5lbmNvZGluZyk7XG4gICAgfWVsc2V7XG4gICAgICAgIG1lc3NhZ2U9ZXZlbnRQYXJzZXIuZm9ybWF0KG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGlmKHRoaXMudWRwNCB8fCB0aGlzLnVkcDYpe1xuICAgICAgICBmb3IobGV0IGk9MSwgY291bnQ9dGhpcy5zb2NrZXRzLmxlbmd0aDsgaTxjb3VudDsgaSsrKXtcbiAgICAgICAgICAgIHRoaXMuc2VydmVyLndyaXRlKG1lc3NhZ2UsdGhpcy5zb2NrZXRzW2ldKTtcbiAgICAgICAgfVxuICAgIH1lbHNle1xuICAgICAgICBmb3IobGV0IGk9MCwgY291bnQ9dGhpcy5zb2NrZXRzLmxlbmd0aDsgaTxjb3VudDsgaSsrKXtcbiAgICAgICAgICAgIHRoaXMuc29ja2V0c1tpXS53cml0ZShtZXNzYWdlKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZnVuY3Rpb24gaW5pdChwYXRoLGNvbmZpZyxsb2cscG9ydCl7XG4gICAgbGV0IHNlcnZlcj17XG4gICAgICAgIGNvbmZpZyAgICAgICAgICA6IGNvbmZpZyxcbiAgICAgICAgcGF0aCAgICAgICAgICAgIDogcGF0aCxcbiAgICAgICAgcG9ydCAgICAgICAgICAgIDogcG9ydCxcbiAgICAgICAgdWRwNCAgICAgICAgICAgIDogZmFsc2UsXG4gICAgICAgIHVkcDYgICAgICAgICAgICA6IGZhbHNlLFxuICAgICAgICBsb2cgICAgICAgICAgICAgOiBsb2csXG4gICAgICAgIHNlcnZlciAgICAgICAgICA6IGZhbHNlLFxuICAgICAgICBzb2NrZXRzICAgICAgICAgOiBbXSxcbiAgICAgICAgZW1pdCAgICAgICAgICAgIDogZW1pdCxcbiAgICAgICAgYnJvYWRjYXN0ICAgICAgIDogYnJvYWRjYXN0LFxuICAgICAgICBvblN0YXJ0ICAgICAgICAgOiBmdW5jdGlvbiBvblN0YXJ0KHNvY2tldCl7XG4gICAgICAgICAgICB0aGlzLnRyaWdnZXIoXG4gICAgICAgICAgICAgICAgJ3N0YXJ0JyxcbiAgICAgICAgICAgICAgICBzb2NrZXRcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0sXG4gICAgICAgIHN0b3A6ZnVuY3Rpb24gc3RvcCgpe1xuICAgICAgICAgICAgc2VydmVyLnNlcnZlci5jbG9zZSgpO1xuICAgICAgICB9LFxuICAgICAgICBzdGFydCAgICAgICAgICAgOiBmdW5jdGlvbiBzdGFydCgpe1xuICAgICAgICAgICAgaWYoIXRoaXMucGF0aCl7XG4gICAgICAgICAgICAgICAgc2VydmVyLmxvZygnU29ja2V0IFNlcnZlciBQYXRoIG5vdCBzcGVjaWZpZWQsIHJlZnVzaW5nIHRvIHN0YXJ0Jy53YXJuKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZzLnVubGluayhcbiAgICAgICAgICAgICAgICB0aGlzLnBhdGgsXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIubG9nKFxuICAgICAgICAgICAgICAgICAgICAgICAgJ3N0YXJ0aW5nIHNlcnZlciBvbiAnLmRlYnVnLHNlcnZlci5wYXRoLnZhcmlhYmxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgKChzZXJ2ZXIucG9ydCk/YDoke3NlcnZlci5wb3J0fWA6JycpLnZhcmlhYmxlXG4gICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYoIXNlcnZlci51ZHA0ICYmICFzZXJ2ZXIudWRwNil7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZighc2VydmVyLmNvbmZpZy50bHMpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5zZXJ2ZXI9bmV0LmNyZWF0ZVNlcnZlcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyQ3JlYXRlZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIubG9nKCdzdGFydGluZyBUTFMgc2VydmVyJy5kZWJ1ZyxzZXJ2ZXIuY29uZmlnLnRscyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2VydmVyLmNvbmZpZy50bHMucHJpdmF0ZSl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5jb25maWcudGxzLmtleT1mcy5yZWFkRmlsZVN5bmMoc2VydmVyLmNvbmZpZy50bHMucHJpdmF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5jb25maWcudGxzLmtleT1mcy5yZWFkRmlsZVN5bmMoYCR7X19kaXJuYW1lfS8uLi9sb2NhbC1ub2RlLWlwYy1jZXJ0cy9wcml2YXRlL3NlcnZlci5rZXlgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2VydmVyLmNvbmZpZy50bHMucHVibGljKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLmNvbmZpZy50bHMuY2VydD1mcy5yZWFkRmlsZVN5bmMoc2VydmVyLmNvbmZpZy50bHMucHVibGljKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLmNvbmZpZy50bHMuY2VydD1mcy5yZWFkRmlsZVN5bmMoYCR7X19kaXJuYW1lfS8uLi9sb2NhbC1ub2RlLWlwYy1jZXJ0cy9zZXJ2ZXIucHViYCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNlcnZlci5jb25maWcudGxzLmRocGFyYW0pe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIuY29uZmlnLnRscy5kaHBhcmFtPWZzLnJlYWRGaWxlU3luYyhzZXJ2ZXIuY29uZmlnLnRscy5kaHBhcmFtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoc2VydmVyLmNvbmZpZy50bHMudHJ1c3RlZENvbm5lY3Rpb25zKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIHNlcnZlci5jb25maWcudGxzLnRydXN0ZWRDb25uZWN0aW9ucyA9PT0gJ3N0cmluZycpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLmNvbmZpZy50bHMudHJ1c3RlZENvbm5lY3Rpb25zPVtzZXJ2ZXIuY29uZmlnLnRscy50cnVzdGVkQ29ubmVjdGlvbnNdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5jb25maWcudGxzLmNhPVtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTxzZXJ2ZXIuY29uZmlnLnRscy50cnVzdGVkQ29ubmVjdGlvbnMubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLmNvbmZpZy50bHMuY2EucHVzaChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcy5yZWFkRmlsZVN5bmMoc2VydmVyLmNvbmZpZy50bHMudHJ1c3RlZENvbm5lY3Rpb25zW2ldKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIuc2VydmVyPXRscy5jcmVhdGVTZXJ2ZXIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5jb25maWcudGxzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXJDcmVhdGVkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBVRFBXcml0ZShtZXNzYWdlLHNvY2tldCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGE9bmV3IEJ1ZmZlcihtZXNzYWdlLCBzZXJ2ZXIuY29uZmlnLmVuY29kaW5nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIuc2VydmVyLnNlbmQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXQucG9ydCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0LmFkZHJlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGVyciwgYnl0ZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVycil7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLmxvZygnZXJyb3Igd3JpdGluZyBkYXRhIHRvIHNvY2tldCcud2FybixlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci50cmlnZ2VyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZXJyb3InLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbihlcnIpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLnRyaWdnZXIoJ2Vycm9yJyxlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5zZXJ2ZXI9ZGdyYW0uY3JlYXRlU29ja2V0KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICgoc2VydmVyLnVkcDQpPyAndWRwNCc6J3VkcDYnKVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5zZXJ2ZXIud3JpdGU9VURQV3JpdGU7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIuc2VydmVyLm9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsaXN0ZW5pbmcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyQ3JlYXRlZChzZXJ2ZXIuc2VydmVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgc2VydmVyLnNlcnZlci5vbihcbiAgICAgICAgICAgICAgICAgICAgICAgICdlcnJvcicsXG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbihlcnIpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5sb2coJ3NlcnZlciBlcnJvcicud2FybixlcnIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLnRyaWdnZXIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdlcnJvcicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVyclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgc2VydmVyLnNlcnZlci5tYXhDb25uZWN0aW9ucz1zZXJ2ZXIuY29uZmlnLm1heENvbm5lY3Rpb25zO1xuXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHNlcnZlckNyZWF0ZWQoc29ja2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIuc29ja2V0cy5wdXNoKHNvY2tldCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNvY2tldC5zZXRFbmNvZGluZyl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0LnNldEVuY29kaW5nKHNlcnZlci5jb25maWcuZW5jb2RpbmcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIubG9nKCcjIyBzb2NrZXQgY29ubmVjdGlvbiB0byBzZXJ2ZXIgZGV0ZWN0ZWQgIyMnLnJhaW5ib3cpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0Lm9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjbG9zZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oc29ja2V0KXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLnRyaWdnZXIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2xvc2UnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0Lm9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdlcnJvcicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oZXJyKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLmxvZygnc2VydmVyIHNvY2tldCBlcnJvcicud2FybixlcnIpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci50cmlnZ2VyKCdlcnJvcicsZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXQub24oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RhdGEnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGRhdGEsVURQU29ja2V0KXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNvY2s9KChzZXJ2ZXIudWRwNCB8fCBzZXJ2ZXIudWRwNik/IFVEUFNvY2tldCA6IHNvY2tldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNlcnZlci5jb25maWcucmF3QnVmZmVyKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE9bmV3IEJ1ZmZlcihkYXRhLHRoaXMuZW5jb2RpbmcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLnRyaWdnZXIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RhdGEnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc29ja1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCF0aGlzLmlwY0J1ZmZlcil7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlwY0J1ZmZlcj0nJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE9KHRoaXMuaXBjQnVmZmVyKz1kYXRhKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihkYXRhLnNsaWNlKC0xKSE9ZXZlbnRQYXJzZXIuZGVsaW1pdGVyIHx8IGRhdGEuaW5kZXhPZihldmVudFBhcnNlci5kZWxpbWl0ZXIpID09IC0xKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5sb2coJ0ltcGxlbWVudGluZyBsYXJnZXIgYnVmZmVyIGZvciB0aGlzIHNvY2tldCBtZXNzYWdlLiBZb3UgbWF5IHdhbnQgdG8gY29uc2lkZXIgc21hbGxlciBtZXNzYWdlcycubm90aWNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXBjQnVmZmVyPScnO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE9ZXZlbnRQYXJzZXIucGFyc2UoZGF0YSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoZGF0YS5sZW5ndGg+MCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbWVzc2FnZT1uZXcgTWVzc2FnZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UubG9hZChkYXRhLnNoaWZ0KCkpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIubG9nKCdyZWNlaXZlZCBldmVudCBvZiA6ICcuZGVidWcsbWVzc2FnZS50eXBlLmRhdGEsbWVzc2FnZS5kYXRhKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobWVzc2FnZS5kYXRhLmlkKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb2NrLmlkPW1lc3NhZ2UuZGF0YS5pZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLnRyaWdnZXIoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS50eXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuZGF0YSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb2NrXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0Lm9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbihtc2cscmluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyaW5mbyl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIubG9nKCdSZWNlaXZlZCBVRFAgbWVzc2FnZSBmcm9tICcuZGVidWcsIHJpbmZvLmFkZHJlc3MudmFyaWFibGUsIHJpbmZvLnBvcnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGF0YTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihzZXJ2ZXIuY29uZmlnLnJhd1NvY2tldCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhPW5ldyBCdWZmZXIobXNnLHRoaXMuZW5jb2RpbmcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE9bXNnLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc29ja2V0LmVtaXQoJ2RhdGEnLGRhdGEscmluZm8pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci50cmlnZ2VyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjb25uZWN0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXRcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHNlcnZlci5jb25maWcucmF3QnVmZmVyKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBzdGFydGVkKHNvY2tldCl7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIub25TdGFydChzb2NrZXQpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYoIXBvcnQpe1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLmxvZygnc3RhcnRpbmcgc2VydmVyIGFzJy5kZWJ1ZywgJ1VuaXggfHwgV2luZG93cyBTb2NrZXQnLnZhcmlhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzLnBsYXRmb3JtID09PSd3aW4zMicpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5wYXRoID0gc2VydmVyLnBhdGgucmVwbGFjZSgvXlxcLy8sICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIucGF0aCA9IHNlcnZlci5wYXRoLnJlcGxhY2UoL1xcLy9nLCAnLScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5wYXRoPSBgXFxcXFxcXFwuXFxcXHBpcGVcXFxcJHtzZXJ2ZXIucGF0aH1gO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIuc2VydmVyLmxpc3RlbihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIucGF0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydGVkXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZighc2VydmVyLnVkcDQgJiYgIXNlcnZlci51ZHA2KXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlci5sb2coJ3N0YXJ0aW5nIHNlcnZlciBhcycuZGVidWcsIChzZXJ2ZXIuY29uZmlnLnRscz8nVExTJzonVENQJykudmFyaWFibGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLnNlcnZlci5saXN0ZW4oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLnBvcnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLnBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRlZFxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHNlcnZlci5sb2coJ3N0YXJ0aW5nIHNlcnZlciBhcycuZGVidWcsKChzZXJ2ZXIudWRwNCk/ICd1ZHA0JzondWRwNicpLnZhcmlhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgc2VydmVyLnNlcnZlci5iaW5kKFxuICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyLnBvcnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXJ2ZXIucGF0aFxuICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0ZWQoXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyA6IHNlcnZlci5wYXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcnQgICAgOiBzZXJ2ZXIucG9ydFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgbmV3IFB1YnN1YihzZXJ2ZXIpO1xuXG4gICAgc2VydmVyLm9uKFxuICAgICAgICAnY2xvc2UnLFxuICAgICAgICBmdW5jdGlvbigpe1xuICAgICAgICAgICAgZm9yKGxldCBpPTAsIGNvdW50PXNlcnZlci5zb2NrZXRzLmxlbmd0aDsgaTxjb3VudDsgaSsrKXtcbiAgICAgICAgICAgICAgICBsZXQgc29ja2V0PXNlcnZlci5zb2NrZXRzW2ldO1xuICAgICAgICAgICAgICAgIGxldCBkZXN0cm95ZWRTb2NrZXRJZD1mYWxzZTtcblxuICAgICAgICAgICAgICAgIGlmKHNvY2tldCl7XG4gICAgICAgICAgICAgICAgICAgIGlmKHNvY2tldC5yZWFkYWJsZSl7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmKHNvY2tldC5pZCl7XG4gICAgICAgICAgICAgICAgICAgIGRlc3Ryb3llZFNvY2tldElkPXNvY2tldC5pZDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzZXJ2ZXIubG9nKCdzb2NrZXQgZGlzY29ubmVjdGVkJy5ub3RpY2UsZGVzdHJveWVkU29ja2V0SWQudG9TdHJpbmcoKS52YXJpYWJsZSk7XG5cbiAgICAgICAgICAgICAgICBpZihzb2NrZXQgJiYgc29ja2V0LmRlc3Ryb3kpe1xuICAgICAgICAgICAgICAgICAgICBzb2NrZXQuZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHNlcnZlci5zb2NrZXRzLnNwbGljZShpLDEpO1xuXG4gICAgICAgICAgICAgICAgc2VydmVyLnRyaWdnZXIoJ3NvY2tldC5kaXNjb25uZWN0ZWQnLCBzb2NrZXQsIGRlc3Ryb3llZFNvY2tldElkKTtcblxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICk7XG5cbiAgICByZXR1cm4gc2VydmVyO1xufVxuXG5tb2R1bGUuZXhwb3J0cz1pbml0O1xuIl19